Configuração do Modem
=====================

.. PX4 and P900 connection https://discuss.px4.io/t/issue-connecting-px4-to-qgroundcontrol-with-microhard-p900/17545


Para que seja feita a configuração dos modens é necessário que este seja conectado a um computador regular. A comunicação de um computador regular com o modem é feita da mesma maneira que a comunicação de um computador regular com o computador embarcado, ou seja, por uma comunicação serial. Por padrão a comunicação serial do modem é feita por uma comunicação UART de 9600 baud/s, 8 bits de dados, sem bit de paridade e 1 bit de parada (**8N1**). Além dessas configurações da comunicação UART, é adotado ainda o padrão físico de conexão serial RS-232.

Logo, para conectar um computador regular ao modem é necessário, primeiro, um cabo conversor de **USB para RS-232**, similar ao apresentado na imagem a seguir. Assim como na comunicação com o computador embarcado, recomenda-se a utilização de um computador Linux com o programa "**screen**"para a configuração dos modens.

.. figure:: /img/Aerial/USBtoRS.jpg
    :align: center

A configuração do modem só pode ser feita utilizando as configurações padrões do modem, ou seja, sempre que o modo configuração for ativado o modem retorna, temporariamente, para as configurações descritas no parágrafo anterior, após sair do modo de configuração o modem volta a operar de acordo com as configurações determinadas em seus registradores.

O modo de configuração pode ser iniciado de duas maneiras. Em ambos os casos é necessário, primeiro, conectar o computador regular ao modem, iniciar o terminal do computador regular e executar o programa "screen", por exemplo:

::

  $ sudo screen /dev/ttyUSB0 9600
  
No caso da linha de comando do exemplo apresentada anteriormente, o termo ``ttyUSB0`` foi a porta encontrada ao utilizar o comando ``dmesg`` e "**9600**" é a velocidade de comunicação em *baud*. Nesse momento a comunicação entre o modem e o computador deve ser estabelecida e assim que o modem for ligado os caracteres devem começar a ser impressos na tela do computador.  
 
A primeira maneira de acessar o modo de configuração é pressionar e segurar o botão "**CONFIG**", energizar o modem e só depois soltar o botão, a outra opção consiste em ligar o modem normalmente e, depois que este estiver no modo de dados (modo de operação regular) enviar a sequência de caracteres "**+++**" e esperar 1 segundo. Realizado qualquer um dos dois métodos a mensagem "NO CARRIER OK" deve aparecer no monitor indicando a entrada no modo de configuração. 
  
.. figure:: /img/Aerial/NOCARRIER.png
    :align: center  
    
Comandos Básicos
~~~~~~~~~~~~~~~~

Uma vez acessado o modo de configuração, podemos começar a dar comandos ao modem. Todos os comandos do modem possuem um prefixo de dois caracteres "**AT**", logo depois desses dois caracteres deve ser inserido o comando propriamente dito. Por exemplo, o comando que retorna para o modo de transmissão de dados é o comando "**A**", portanto para retornar ao modo de dados deve-se digitar ``ATA``.  

O comando ``ATI`` retorna informações sobre o modem P900. O comando ``ATlogin`` protege as configurações e o acesso ao modo de comando por uma senha a ser definida pelo usuário. O comando ``ATM`` ativa um menu do modo de operação rede, que será explicado mais a frente, útil para identificação de erros e obtenção de logs. Já o comando ``AT&V`` imprime os nomes e valores atuais dos registradores **S**, enquanto o comando ``AT&V1`` exibe um conjunto completo de parâmetros avançados do usuário. Vale destacar também o comando ``AT&W``, ele escreve as alterações feitas nos registradores do modem, se esse último comando não for executado antes de sair do modo de configuração todas as alterações serão descartadas.  

.. figure:: /img/Aerial/P900_Fn.png
    :align: right  
    :width: 180px

Por ultimo, o comando ``AT&Fn``, em *n* é o valor que representa os perfis de configuração (imagem a direita), permite a configuração rapida do sistema, definindo configurações de fabrica recomendadas para cada modo de operação. Tais configurações de fábrica alteram todas as configurações necessárias para iniciar a comunicação padrão com outros tipos de unidades. Este comando e os modos de operação seram explicados de forma detalhada adiante.

.. Note::
  A seção 6.1 (pagina 80) do manual de instruções do modem P900 apresenta mais detalhes a respeito dos comandos AT. 

Registradores
~~~~~~~~~~~~~

A maior parte das configurações do modem são feitas atraves da configuração dos Registradores (**S**). Para isso, deve-se utilizar o comando ``ATSn=<value>``, no qual a letra "*n*" deve ser trocada pelo valor do registrador desejado. Destacasse  ainda os comandos ``ATSn?``, consulta o valor atual do registrador *n*, e ``ATSn/?``, disponibiliza mais informações sobre o registrador *n*.

.. testar o ATSn? e o ATSn/?

.. Note::
  O modem apresenta muitos registradores, portanto nem todos seram relatados aqui. Mais informações sobre a configuração dos registradores estão disponiveis na seção 6.2 (pagina 83) do manual de instruções do modem P900.

.. Warning::
  Quase todas as características do modem podem ser alteradas atraves dos registradores, todavia, para faze-las, recomenda-se consultar o manual para especificações detalhadas.
   
O registrador "**S0**" é usado para selecionar o modo no qual o dispositivo é ligado, podendo ser configurado para iniciar no modo de comando ou no modo de dados (padrão). O caractere de escape (0-255) usado na detecção de escape para colocar o modem offline pode ser desabilitado/alterado no registrador "**S2**". Já a função do modem dentro do modo de operação, a velocidade da comunicação serial com o dispositivo conectado ao modem e a velocidade da comunicação com os outros modens via propagação de ondas eletromagnéticas podem ser modificadas nos registradores "**S101**", "**S102**" e "**S103**", respectivamente. O formato da comunicação serial com o dispositivo e o número mínimo de bytes a serem transmitidos podem ser alterados nos registrador "**S110**" e "**S111**", respectivamente. O tipo de modo de operação é determinado pelo registrador "**S133**". Enquanto o modo de comunicação serial é determinado pelo registrador "**142**". Por ultimo, o modo de acesso ao canal de comunicação pode ser alterado no registrador "**244**".  

A tabela a seguir mostra os principais valores que devem ser observados nos respectivos registadores para que o modo de operação do tipo rede funcione para a nossa aplicação.
   
+-------------+-------------------------+------------+
| Registrador |           Nome          |    Valor   |
+=============+=========================+============+
|  S80        |     Transmit Profilescc |      0     |
+-------------+-------------------------+------------+
|  S81        |      CS Threshold             60     |
+-------------+-------------------------+------------+
| S102        |     Serial Baud Rate    |      7     |
+-------------+-------------------------+------------+          
| S103        |     Wireless Link Rate  |      0     |
+-------------+-------------------------+------------+
| S104        |      Network Address    | 1286608618 |
+-------------+-------------------------+------------+
| S110        |       Data Format       |      1     |
+-------------+-------------------------+------------+ 
| S115        |      Repeat Interval    |      5     |
+-------------+-------------------------+------------+
| S126        | Attempt Before Re-route |      9     |
+-------------+-------------------------+------------+
| S133        |       Network Type      |      2     |
+-------------+-------------------------+------------+
| S142        |   Serial Channel Mode   |      0     |
+-------------+-------------------------+------------+
| S244        |    Channel Acess Mode   |      1     |
+-------------+-------------------------+------------+

Topologia da transmissão de dados
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

O modem Microhard P900 pode ser configurado para operar em três topologias de transmissão de dados: **configuração de malha**, **configuração ponto-a-ponto** e **configuração ponto-a-multiponto**.

Configuração de malha
---------------------

A configuração de rede ou malha (*Mesh Network*) é um modo de operação onde todos os dispositivos conectados à rede comunicam-se entre si, a mensagem enviada por um modem é recebida simultaneamente por todos os outros modens com a mesma configuração, que estejam dentro da área de cobertura. Os rádios podem se comunicar diretamente ou, se necessário, por meio de outro nó da malha.

Nas situações em que um caminho direto entre os dispositivos de origem e de destino não está disponível, o roteamento pode encontrar rotas para assegurar que os dados sejam entregues ao destino necessário. O modo rede pode ainda ser configurado de forma que caminhos redundantes estejam disponíveis para transferência de dados, rotas desconhecidas podem ser descobertas automaticamente e o melhor caminho é usado para alcançar o destino pretendido.

A configuração de malha é ativada configurando o registrador **S133** como "2" ou "3". A imagem abaixo exemplifica o funcionamento do modo de operação rede, onde existem varios caminhos que os dados podem seguir. 

.. figure:: /img/Aerial/Mesh_Network.png
    :align: center

Modo ponto-a-ponto
------------------

O modo de configuração ponto-a-ponto é um modo de operação em que a comunicação é apenas entre um modem "mestre" e um modem "escravo". Podem haver repetidores de sinal entre eles, porém a mensagem enviada por um é recebida apenas pelo seu correspondente.

.. editando

Modo ponto-a-multiponto
-----------------------

E, por último, existe o modo ponto-a-multiponto onde um modem mestre se comunica com vários modens escravos, toda a informação originada dos escravos é direcionada ao mestre e, quando necessário ou desejável, cabe ao mestre repassar essa informação ao destino final, nessa topologia toda a informação passa pelo mestre, que controla a rede.

.. editando

Conclusão
---------

Evidentemente, para a nossa aplicação, a topologia mais interessante é a topologia de rede. Nessa topologia todos os modens receberão a informação simultaneamente, sendo mais rápida que outras topologias, além disso a maior parte da informação gerada em nosso caso tem mesmo o objetivo de ser transmitida a todos os outros dispositivos.

Explorando a configuração de malha
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Dado que utilizaremos a topologia de malha para a transmissão de dados no projeto, nessa seção iremos examinar e detalhar as principais características e funcionalidades dessa topologia em especifico.

Modos de operação/tipos de unidades
-------------------------------------

No modo de rede da Microhard, existem quatro tipos de unidades ou modos de operação disponíveis: o **coordenador primário**, o **coordenador secundário**, o **coordenador de espera** e o **remoto**.

O papel do *coordenador principal* é prover sincronização de rede para o sistema, o que garante que todas as unidades estejam ativas e preparados para se comunicar conforme necessário. Em qualquer modo de malha, só pode haver um único coordenador primário. Coordenadores adicionais podem ser estabelecidos para redundância e/ou para estender a cobertura da rede a áreas não atendidas pelo coordenador principal. Para quaisquer unidades poderem se comunicar em uma malha, elas devem ser capazes de captar os dados de sincronização de um coordenador.

O diagrama abaixo simboliza uma unidade configurada como coordenador principal. Qualquer outra unidade de malha que possa receber os dados do coordenador principal, pode participar da rede de malha.

.. figure:: /img/Aerial/Primary_Coordinator.png
    :align: center

Os *coordenadores secundários* são usados ​​para estender a cobertura do coordenador principal. Mais de um coordenador secundário pode ser usado para redundância ou para garantir uma cobertura de rede adequada. Um coordenador secundário deve se comunicar com o coordenador principal e/ou outro coordenador secundário para garantir a sincronização adequada com as unidades que atende.

.. editando

.. figure:: /img/Aerial/Secundary_Coordinator.png
    :align: center

Um *coordenador de espera* monitora o nível de sincronização da rede e, quando detecta que o coordenador principal fica offline ou não está realizando suas tarefas de sincronização de rede por qualquer motivo, o coordenador de espera pode assumir o controle.

.. editando

.. figure:: /img/Aerial/Standby_Coordinator.png
    :align: center

Um *remoto* (escravo) é qualquer unidade que não seja um coordenador. Um controle remoto geralmente está conectado a um dispositivo final, mas também pode ser implantado para fornecer caminhos redundantes para alcançar outros dispositivos na rede. Como em qualquer outro dispositivo da rede, o controle remoto pode ser usado para fornecer serviços de roteamento. Embora todas as unidades possam ser configuradas para fornecer serviços de roteamento, não é eficiente fazê-lo, pois haveria que lidar com uma grande sobrecarga de largura de banda da rede.

.. editando

.. figure:: /img/Aerial/Remote.png
    :align: center


Modos de Acesso ao Canal
------------------------

Existem, também, três modos de acesso ao canal, "Aloha", "RTS/CTS" e "TDMA".

O modo "Aloha" é um protocolo de acesso ao meio no qual sempre que um dispositivos possui dados a serem enviados esse dispositivo aguarda um período aleatório e tenta enviar esse dado. Caso, nessa tentativa, seja recebido pelo dispositivo algum outro sinal é assumido que houve colisão de dados e portanto a transmissão de dados é abortada, aguardam-se, novamente, um período de tempo aleatório até que a mensagem seja novamente enviada. O processo se repete até que o dado tenha sido inteiramente enviado sem que haja colisão.

O modo "RTS/CTS" do inglês Request to Send/Clear to Send é um modo que tem o objetivo de diminuir a colisão de transferência de dados, inclusive devido ao problema do terminal escondido. Nesse modo cada modem escravo, quando possui dados para enviar, solicita permissão de envio para o modem mestre por um canal alternativo, o modem mestre verifica se o canal principal está ocupado e responde à solicitação permitindo ou não a transferência de dados. As mensagens de solicitação e liberação são endereçadas para garantir que dois modens distintos não entendam que estão liberados para enviar informações.

Por último o modo "TDMA" do inglês Time Domain Multiple Access, nesse modo a cada modem é definido um intervalo de tempo ao qual o modem pode transmitir dados. Após o fim do intervalo de tempo de um modem se inicia o intervalo de tempo do modem seguinte e assim por diante, quando o intervalo de tempo do último modem acabar o processo se reinicia. Uma desvantagem desse modo é a necessidade de esperar um intervalo de tempo de um dispositivo mesmo que ele não possua dados para transmitir.

Dos modos apresentados o modo RTS/CTS é o modo que, aparentemente, vai apresentar melhor resultado pois não é necessário esperar por dispositivos que não tem dados a enviar e apresenta pequenas chances de colisão de dados.

Configuração para cada tipo de unidade no modo de rede
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. Tip::
   O registrador que configura qual a função do modem a ser utilizada no modo rede é o S101.
   
A tabela a seguir mostra os valores que de devem ser colocados no registrador 101 para que o modem desempenhe o papel desejado.   

+-------------+------------+
| Função      |    Valor   |
+=============+============+
| Primário    |      4     |
+-------------+------------+
| Secundário  |      5     |
+-------------+------------+
| Espera      |      6     |
+-------------+------------+
| Remoto      |      2     |
+-------------+------------+

Para auxiliar na configuração e implantação dos módulos da série Pico, as configurações padrão de fábrica podem ser usadas como um ponto de partida conhecido para cada tipo de unidade. O uso dos comandos padrão de fábrica define todos os valores dos registradores ​​para as configurações recomendadas de fábrica e permite a conectividade inicial entre as unidades. Para a nossa aplicação de rede, esses comandos são tudo o que é necessário para configurar e implantar uma rede de malha.

+-------------+------------+
| Função      |   Comando  |
+=============+============+
| Primário    |    AT&F1   |
+-------------+------------+
| Secundário  |    AT&F3   |
+-------------+------------+
| Remoto      |    AT&F2   |
+-------------+------------+

.. Tip::
   Para a nossa aplicação é necessário um coordenador primário e dois remotos.

.. ATENÇÃO ATENÇÃO: CONFERIR SE ESSE TIP ACIMA SERÁ CORRETO!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

A seguir é apresentado os passos que devem ser digitados no terminal após a verificação da mensagem "NO CARRIER OK" para que a configuração seja realizada com sucesso.

:: 
  
  Para o *coordenador primário*
  $ AT&F1
  $ AT&W
  
::
  
  Para o *remoto*
  $ AT&F2
  $ AT&W
    
Após esses comandos, caso queira verificar se foram feitas corretamente as alterações nos registradores, use o comando abaixo e verifique se assemelha com as fotos a seguir.  

:: 
  
  $ AT&V
  
Para o coordenador primário é retornado os seguintes valores nos registradores (Atenção ao S101):

.. figure:: /img/Aerial/Primario.png
    :align: center

Para o remoto é retornado os seguintes valores nos registradores (Atenção ao S101):   

.. figure:: /img/Aerial/Remoto.png
    :align: center

Referências
-----------

* PITA, H. C. Desenvolvimento de sistema de comunicação multiplataforma para veículos aéreos de asa fixa. Faculdade de Tecnologia, Universidade de Brasília, 2018.



